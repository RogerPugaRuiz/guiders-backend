name: Simple Staging Deploy

on:
  push:
    branches:
      - develop
      - feature/*
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  # Test bÃ¡sico y build
  test-and-build:
    name: Test and Build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run lint
        run: npm run lint
      
      - name: Build project
        run: npm run build
      
      - name: Run unit tests
        run: npm run test:unit

  # Deploy simulado a staging
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [test-and-build]
    if: needs.test-and-build.result == 'success'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup staging environment
        run: |
          echo "ðŸ”§ Configurando staging..."
          echo "NODE_ENV=staging" > .env.staging
          echo "PORT=3000" >> .env.staging
          echo "DATABASE_HOST=localhost" >> .env.staging
          echo "DATABASE_USERNAME=guiders_staging" >> .env.staging
          echo "DATABASE_PASSWORD=staging_password" >> .env.staging
          echo "DATABASE=guiders_staging" >> .env.staging
          echo "REDIS_URL=redis://localhost:6379" >> .env.staging
          echo "MONGODB_URL=mongodb://admin:password@localhost:27017/guiders_staging" >> .env.staging
      
      - name: Deploy to staging
        run: |
          echo "ðŸš€ Desplegando a staging..."
          echo "ðŸ“¦ Branch: ${{ github.ref_name }}"
          echo "ðŸ“ Commit: ${{ github.sha }}"
          echo "âœ… Deploy completado (simulado)"
          
          # En un entorno real:
          # scp .env.staging user@staging-server:/var/www/guiders/
          # ssh user@staging-server 'cd /var/www/guiders && git pull && npm install && pm2 restart guiders'
      
      - name: Verify deployment
        run: |
          echo "ðŸ” Verificando deployment..."
          echo "âœ… Staging funcionando correctamente"
          echo "ðŸŒ URL: https://staging.guiders.app"

  # Resumen final
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [test-and-build, deploy-staging]
    if: always()
    
    steps:
      - name: Show results
        run: |
          echo "# ðŸ“Š Resumen de Staging Deploy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tests:** ${{ needs.test-and-build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deploy:** ${{ needs.deploy-staging.result }}" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.deploy-staging.result }}" == "success" ]]; then
            echo "## âœ… Deploy Exitoso" >> $GITHUB_STEP_SUMMARY
            echo "Staging actualizado correctamente" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Deploy Fallido" >> $GITHUB_STEP_SUMMARY
            echo "Revisar logs para mÃ¡s detalles" >> $GITHUB_STEP_SUMMARY
          fi
