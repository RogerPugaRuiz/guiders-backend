name: ğŸ¤– Auto-Update API Documentation

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/context/**/controllers/*.controller.ts'
      - 'src/context/**/application/dtos/*.dto.ts' 
      - 'src/context/**/infrastructure/controllers/*.ts'
  pull_request:
    paths:
      - 'src/context/**/controllers/*.controller.ts'
      - 'src/context/**/application/dtos/*.dto.ts'
      - 'src/context/**/infrastructure/controllers/*.ts'

jobs:
  update-api-docs:
    name: ğŸ“– Actualizar DocumentaciÃ³n API
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ”§ Instalar dependencias
      run: npm ci

    - name: ğŸš€ Generar documentaciÃ³n API
      run: |
        chmod +x scripts/generate-api-docs.js
        node scripts/generate-api-docs.js

    - name: âœ… Validar documentaciÃ³n
      run: |
        chmod +x scripts/validate-api-docs.js
        node scripts/validate-api-docs.js

    - name: ğŸ“ Verificar cambios
      id: changes
      run: |
        if git diff --quiet HEAD -- docs/api-ai/; then
          echo "changed=false" >> $GITHUB_OUTPUT
        else
          echo "changed=true" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ“Š Mostrar estadÃ­sticas
      if: steps.changes.outputs.changed == 'true'
      run: |
        echo "ğŸ“ˆ CAMBIOS DETECTADOS:"
        echo "ğŸ“„ Archivos modificados:"
        git diff --name-only HEAD -- docs/api-ai/
        echo ""
        echo "ğŸ“Š EstadÃ­sticas:"
        ls -lh docs/api-ai/api-documentation*.json
        echo ""
        echo "ğŸ”— Total endpoints:"
        grep -c '"POST"\|"GET"\|"PUT"\|"DELETE"' docs/api-ai/api-documentation-compact.json || echo "Error contando endpoints"

    - name: ğŸ’¾ Commit cambios automÃ¡ticos
      if: steps.changes.outputs.changed == 'true' && github.event_name == 'push'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add docs/api-ai/
        git commit -m "ğŸ¤– Auto-update: DocumentaciÃ³n API actualizada
        
        - Regenerada automÃ¡ticamente por cambios en controllers
        - Incluye versiÃ³n completa y compacta
        - ValidaciÃ³n automÃ¡tica completada
        
        Archivos actualizados:
        $(git diff --name-only HEAD~1 -- docs/api-ai/ | sed 's/^/- /')"
        git push

    - name: ğŸ“‹ Comentario en PR
      if: steps.changes.outputs.changed == 'true' && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          // Leer estadÃ­sticas
          const compactSize = fs.statSync('docs/api-ai/api-documentation-compact.json').size;
          const fullSize = fs.statSync('docs/api-ai/api-documentation.json').size;
          
          const comment = `## ğŸ¤– DocumentaciÃ³n API Actualizada AutomÃ¡ticamente
          
          âœ… **Cambios detectados en controllers - DocumentaciÃ³n regenerada**
          
          ### ğŸ“Š EstadÃ­sticas:
          - ğŸ“„ **DocumentaciÃ³n completa**: ${(fullSize/1024).toFixed(1)}KB
          - ğŸ¯ **DocumentaciÃ³n compacta**: ${(compactSize/1024).toFixed(1)}KB  
          - ğŸ”— **Endpoints**: \`grep -c '"POST"\\|"GET"\\|"PUT"\\|"DELETE"' docs/api-ai/api-documentation-compact.json\`
          
          ### ğŸ“ Archivos actualizados:
          ${process.env.GITHUB_HEAD_REF ? '- api-documentation.json\n- api-documentation-compact.json\n- executive-summary.json' : 'Ver commit automÃ¡tico'}
          
          ---
          *ğŸ¤– Actualizado automÃ¡ticamente por GitHub Actions*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  validate-only:
    name: âœ… Solo Validar (sin cambios)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - run: npm ci
    
    - name: ğŸ” Validar documentaciÃ³n existente
      run: |
        if [ -f "scripts/validate-api-docs.js" ]; then
          node scripts/validate-api-docs.js
        else
          echo "âš ï¸ Script de validaciÃ³n no encontrado"
        fi