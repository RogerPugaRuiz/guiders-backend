name: CI Pipeline

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: # Permite ejecutar manualmente

# Configuraci√≥n global para cancelar workflows concurrentes
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  CACHE_VERSION: v1

jobs:
  # Job para verificar lint y formato - CR√çTICO
  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    continue-on-error: false # CR√çTICO: debe pasar obligatoriamente
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Obtiene todo el historial para mejor an√°lisis
      
      - name: Setup Node.js with enhanced caching
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'
      
      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ env.CACHE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-${{ env.CACHE_VERSION }}-
            ${{ runner.os }}-npm-
      
      - name: Install dependencies with retry
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          command: npm ci
      
      - name: Run ESLint (CR√çTICO)
        run: npm run lint
        continue-on-error: false
      
      - name: Check Prettier formatting (CR√çTICO)
        run: npm run format -- --check
        continue-on-error: false

  # Job para compilar el proyecto - CR√çTICO
  build:
    name: Build Project
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [lint] # Depende de lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js with enhanced caching
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'
      
      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ env.CACHE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-${{ env.CACHE_VERSION }}-
            ${{ runner.os }}-npm-
      
      - name: Install dependencies with retry
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          command: npm ci
      
      - name: Cache TypeScript build
        uses: actions/cache@v4
        with:
          path: |
            dist/
            .tsbuildinfo
          key: ${{ runner.os }}-tsc-${{ env.CACHE_VERSION }}-${{ hashFiles('src/**/*.ts', 'tsconfig*.json') }}
          restore-keys: |
            ${{ runner.os }}-tsc-${{ env.CACHE_VERSION }}-
            ${{ runner.os }}-tsc-
      
      - name: Build project
        run: npm run build
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}
          path: dist/
          retention-days: 3
          if-no-files-found: warn

  # Job para tests unitarios - CR√çTICO
  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    continue-on-error: false # CR√çTICO: debe pasar obligatoriamente
    needs: [lint] # Puede ejecutar en paralelo con build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js with enhanced caching
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'
      
      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ env.CACHE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-${{ env.CACHE_VERSION }}-
            ${{ runner.os }}-npm-
      
      - name: Install dependencies with retry
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          command: npm ci
      
      - name: Ensure coverage directory
        run: node src/scripts/ensure-coverage-dir.js || mkdir -p coverage
      
      - name: Run unit tests with coverage (CR√çTICO)
        run: npm run test:unit -- --coverage --coverageReporters=lcov --coverageReporters=text
        continue-on-error: false
      
      - name: Verify coverage directory
        run: |
          ls -la
          ls -la coverage || echo "No coverage directory found"
      
      - name: Upload unit test coverage
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-coverage-${{ github.sha }}
          path: coverage/
          retention-days: 7
          if-no-files-found: warn

  # Job para tests de integraci√≥n - CR√çTICO
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    continue-on-error: false # CR√çTICO: debe pasar obligatoriamente
    needs: [lint] # Puede ejecutar en paralelo con build y unit tests
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: guiders_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
          --health-start-period 30s
        ports:
          - 5432:5432
      
      redis:
        image: redis:6.2
        env:
          REDIS_HOST: localhost
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 30
          --health-start-period 10s
          --name redis-integration
        ports:
          - 6379:6379
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js with enhanced caching
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'
      
      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ env.CACHE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-${{ env.CACHE_VERSION }}-
            ${{ runner.os }}-npm-
      
      - name: Install dependencies with retry
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          command: npm ci
        
      - name: Ensure coverage directory
        run: node src/scripts/ensure-coverage-dir.js || mkdir -p coverage
      
      - name: Enable memory overcommit (required for Redis)
        run: sudo sysctl -w vm.overcommit_memory=1
      
      - name: Wait for services to be ready
        run: |
          echo "Esperando a que los servicios est√©n listos..."
          for i in {1..30}; do
            postgres_ready=false
            redis_ready=false
            
            # Verificar PostgreSQL
            if pg_isready -h localhost -p 5432 -U test >/dev/null 2>&1; then
              postgres_ready=true
              echo "‚úÖ PostgreSQL listo"
            fi
            
            # Verificar Redis
            if redis-cli -h localhost -p 6379 ping >/dev/null 2>&1; then
              redis_ready=true
              echo "‚úÖ Redis listo"
            fi
            
            if $postgres_ready && $redis_ready; then
              echo "üéâ Todos los servicios est√°n listos"
              break
            fi
            
            echo "Intento $i/30: Esperando servicios (PostgreSQL: $postgres_ready, Redis: $redis_ready)..."
            sleep 2
          done
          
          # Verificaci√≥n final
          if ! (pg_isready -h localhost -p 5432 -U test >/dev/null 2>&1 && redis-cli -h localhost -p 6379 ping >/dev/null 2>&1); then
            echo "‚ùå Error: Los servicios no est√°n listos despu√©s de 60 segundos"
            exit 1
          fi
      
      - name: Setup test environment variables
        run: |
          echo "NODE_ENV=test" >> $GITHUB_ENV
          echo "DATABASE_URL=postgresql://test:test@localhost:5432/guiders_test" >> $GITHUB_ENV
          echo "REDIS_URL=redis://localhost:6379" >> $GITHUB_ENV
          echo "TEST_DATABASE_HOST=localhost" >> $GITHUB_ENV
          echo "TEST_DATABASE_PORT=5432" >> $GITHUB_ENV
          echo "TEST_DATABASE_USERNAME=test" >> $GITHUB_ENV
          echo "TEST_DATABASE_PASSWORD=test" >> $GITHUB_ENV
          echo "TEST_DATABASE=guiders_test" >> $GITHUB_ENV
      
      - name: Run integration tests with coverage (CR√çTICO)
        run: npm run test:int -- --coverage --coverageReporters=lcov --coverageReporters=text
        continue-on-error: false
      
      - name: Verify integration coverage directory
        run: |
          ls -la
          ls -la coverage || echo "No coverage directory found"
      
      - name: Upload integration test coverage
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-coverage-${{ github.sha }}
          path: coverage/
          retention-days: 7
          if-no-files-found: warn

  # Job para tests e2e - CR√çTICO
  test-e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    continue-on-error: false # CR√çTICO: debe pasar obligatoriamente
    needs: [build]
    if: success() # Solo ejecuta si build pasa
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: guiders_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
          --health-start-period 30s
        ports:
          - 5432:5432
      
      redis:
        image: redis:6.2
        env:
          REDIS_HOST: localhost
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 30
          --health-start-period 10s
          --name redis-e2e
        ports:
          - 6379:6379
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js with enhanced caching
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'
      
      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ env.CACHE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-${{ env.CACHE_VERSION }}-
            ${{ runner.os }}-npm-
      
      - name: Install dependencies with retry
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          command: npm ci
      
      - name: Download build artifacts (requerido)
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}
          path: dist/
        continue-on-error: false # Debe tener artifacts
      
      - name: Build if no artifacts available
        run: |
          if [ ! -d "dist" ] || [ -z "$(ls -A dist)" ]; then
            echo "No build artifacts found, building project..."
            npm run build
          else
            echo "Using downloaded build artifacts"
          fi
      
      - name: Enable memory overcommit (required for Redis)
        run: sudo sysctl -w vm.overcommit_memory=1
      
      - name: Wait for services to be ready
        run: |
          echo "Esperando a que los servicios est√©n listos..."
          for i in {1..30}; do
            postgres_ready=false
            redis_ready=false
            
            # Verificar PostgreSQL
            if pg_isready -h localhost -p 5432 -U test >/dev/null 2>&1; then
              postgres_ready=true
              echo "‚úÖ PostgreSQL listo"
            fi
            
            # Verificar Redis
            if redis-cli -h localhost -p 6379 ping >/dev/null 2>&1; then
              redis_ready=true
              echo "‚úÖ Redis listo"
            fi
            
            if $postgres_ready && $redis_ready; then
              echo "üéâ Todos los servicios est√°n listos"
              break
            fi
            
            echo "Intento $i/30: Esperando servicios (PostgreSQL: $postgres_ready, Redis: $redis_ready)..."
            sleep 2
          done
          
          # Verificaci√≥n final
          if ! (pg_isready -h localhost -p 5432 -U test >/dev/null 2>&1 && redis-cli -h localhost -p 6379 ping >/dev/null 2>&1); then
            echo "‚ùå Error: Los servicios no est√°n listos despu√©s de 60 segundos"
            exit 1
          fi
      
      - name: Setup test environment variables
        run: |
          echo "NODE_ENV=test" >> $GITHUB_ENV
          echo "DATABASE_URL=postgresql://test:test@localhost:5432/guiders_test" >> $GITHUB_ENV
          echo "REDIS_URL=redis://localhost:6379" >> $GITHUB_ENV
          echo "TEST_DATABASE_HOST=localhost" >> $GITHUB_ENV
          echo "TEST_DATABASE_PORT=5432" >> $GITHUB_ENV
          echo "TEST_DATABASE_USERNAME=test" >> $GITHUB_ENV
          echo "TEST_DATABASE_PASSWORD=test" >> $GITHUB_ENV
          echo "TEST_DATABASE=guiders_test" >> $GITHUB_ENV
      
      - name: Run E2E tests (CR√çTICO)
        run: npm run test:e2e
        continue-on-error: false

  # Job para verificar la cobertura de c√≥digo - NO CR√çTICO (√∫nico permisivo)
  check-coverage:
    name: Check Code Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [test-unit]
    if: always() # Ejecuta incluso si test-unit falla
    continue-on-error: true # NO CR√çTICO: puede fallar sin bloquear
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js with enhanced caching
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'
      
      - name: Download unit test coverage
        uses: actions/download-artifact@v4
        with:
          name: unit-test-coverage-${{ github.sha }}
          path: coverage/
        continue-on-error: true # Si no hay coverage, lo saltamos
      
      - name: Display structure of coverage directory
        run: |
          if [ -d "coverage" ]; then
            ls -la coverage/
          else
            echo "‚ö†Ô∏è No se encontr√≥ directorio de coverage"
          fi
        
      - name: Check coverage threshold with exclusions (NO CR√çTICO)
        run: |
          if [ -f "src/scripts/check-coverage-threshold.js" ]; then
            node src/scripts/check-coverage-threshold.js || {
              echo "‚ö†Ô∏è Coverage por debajo del umbral, pero NO es cr√≠tico"
              exit 0
            }
          else
            echo "‚ö†Ô∏è Script de coverage no encontrado, saltando verificaci√≥n"
          fi
        continue-on-error: true

  # Job opcional para an√°lisis de seguridad - CR√çTICO cuando se ejecuta
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: false # CR√çTICO cuando se ejecuta
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    needs: [lint] # Puede ejecutar en paralelo
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
        continue-on-error: false
      
      - name: Run npm audit (CR√çTICO)
        run: |
          npm audit --audit-level=high || {
            echo "‚ö†Ô∏è Security vulnerabilities detected. Please address them.";
            exit 1;
          }
        continue-on-error: false

  # Job final para verificar que todo est√° OK - CR√çTICO
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [lint, build, test-unit, test-integration, test-e2e, check-coverage, security-scan]
    if: always() # Siempre ejecuta para dar feedback
    
    steps:
      - name: Evaluate results and generate summary
        run: |
          echo "# üìä Resumen del Pipeline CI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Funci√≥n para verificar status de job
          check_job_status() {
            local job_name=$1
            local job_result=$2
            local icon="‚ùì"
            local status="Unknown"
            
            case $job_result in
              "success") icon="‚úÖ"; status="OK" ;;
              "failure") icon="‚ùå"; status="Failed" ;;
              "cancelled") icon="‚èπÔ∏è"; status="Cancelled" ;;
              "skipped") icon="‚è≠Ô∏è"; status="Skipped" ;;
              *) icon="‚ö†Ô∏è"; status="Warning" ;;
            esac
            
            echo "| $job_name | $icon $status |" >> $GITHUB_STEP_SUMMARY
          }
          
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|---------|" >> $GITHUB_STEP_SUMMARY
          
          check_job_status "Lint" "${{ needs.lint.result }}"
          check_job_status "Build" "${{ needs.build.result }}"
          check_job_status "Unit Tests" "${{ needs.test-unit.result }}"
          check_job_status "Integration Tests" "${{ needs.test-integration.result }}"
          check_job_status "E2E Tests" "${{ needs.test-e2e.result }}"
          check_job_status "Coverage Check" "${{ needs.check-coverage.result }}"
          check_job_status "Security Scan" "${{ needs.security-scan.result }}"
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Determinar el estado general
          critical_failures=0
          
          # Todos son cr√≠ticos EXCEPTO coverage
          if [[ "${{ needs.lint.result }}" == "failure" ]]; then
            critical_failures=$((critical_failures + 1))
          fi
          if [[ "${{ needs.build.result }}" == "failure" ]]; then
            critical_failures=$((critical_failures + 1))
          fi
          if [[ "${{ needs.test-unit.result }}" == "failure" ]]; then
            critical_failures=$((critical_failures + 1))
          fi
          if [[ "${{ needs.test-integration.result }}" == "failure" ]]; then
            critical_failures=$((critical_failures + 1))
          fi
          if [[ "${{ needs.test-e2e.result }}" == "failure" ]]; then
            critical_failures=$((critical_failures + 1))
          fi
          if [[ "${{ needs.security-scan.result }}" == "failure" ]]; then
            critical_failures=$((critical_failures + 1))
          fi
          # check-coverage NO es cr√≠tico
          
          if [ $critical_failures -eq 0 ]; then
            echo "üéâ **Pipeline completado exitosamente!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚úÖ Todos los jobs cr√≠ticos han pasado correctamente" >> $GITHUB_STEP_SUMMARY
            
            # Mostrar estado de coverage por separado
            if [[ "${{ needs.check-coverage.result }}" != "success" ]]; then
              echo "‚ö†Ô∏è Coverage fall√≥, pero NO es cr√≠tico" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "‚úÖ Pipeline CI completado exitosamente"
            echo "‚úÖ Lint: ${{ needs.lint.result }}"
            echo "‚úÖ Build: ${{ needs.build.result }}"
            echo "‚úÖ Tests unitarios: ${{ needs.test-unit.result }}"
            echo "‚úÖ Tests de integraci√≥n: ${{ needs.test-integration.result }}"
            echo "‚úÖ Tests E2E: ${{ needs.test-e2e.result }}"
            echo "‚úÖ Security: ${{ needs.security-scan.result }}"
            echo "‚ÑπÔ∏è Coverage (NO cr√≠tico): ${{ needs.check-coverage.result }}"
            
            exit 0
          else
            echo "‚ùå **Pipeline fall√≥ - Jobs cr√≠ticos fallaron**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ùå Hay $critical_failures job(s) cr√≠tico(s) que fallaron" >> $GITHUB_STEP_SUMMARY
            echo "üîç Revisa los logs para m√°s detalles" >> $GITHUB_STEP_SUMMARY
            
            echo "‚ùå Pipeline CI fall√≥ - Jobs cr√≠ticos fallaron"
            echo "Status Lint: ${{ needs.lint.result }}"
            echo "Status Build: ${{ needs.build.result }}"
            echo "Status Tests unitarios: ${{ needs.test-unit.result }}"
            echo "Status Tests de integraci√≥n: ${{ needs.test-integration.result }}"
            echo "Status Tests E2E: ${{ needs.test-e2e.result }}"
            echo "Status Security: ${{ needs.security-scan.result }}"
            echo "‚ÑπÔ∏è Coverage (NO cr√≠tico): ${{ needs.check-coverage.result }}"
            
            exit 1
          fi
